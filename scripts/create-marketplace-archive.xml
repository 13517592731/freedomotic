<?xml version="1.0" encoding="UTF-8"?>

<project name="create-marketplace-archive" default="default" basedir=".">
    <description>Creates a plugin marketplace archive</description>
    
    <!-- if not a plugin folder skip -->
    <target name="default">
        <echo>"Plugin basedir to create marchetplace archive is ${basedir}"</echo>
        <if>
            <matches pattern="/plugins/" string="${basedir}"/>
            <then>
                <antcall target="marketplace"/>
            </then>
            <else>
                <antcall target="exit"/>
            </else>
        </if>
    </target>
    
    <!-- exit message as separate target -->
    <target name="exit">
        <echo message="This is not a plugin, skip this ant target" />
    </target>
    
    <target name="marketplace">
        <!-- CREATE MARKETPLACE ARCHIVE -->
        <echo>Creating the marketplace redestributable archive</echo>
        
        
        <!-- read properties from build.options file -->
        <loadproperties>
            <file file="build.options"/>
        </loadproperties>
        <property name="workspace-base" value="../../../"/>
        <property name="plugin-dist" value="${package.name}"/>
        <property name="market-dist" value="target/marketplace"/>
        <echo>Pluging package name is ${plugin-dist} in marketplace folder ${market-dist}</echo>
        <mkdir dir="${plugin-dist}"/>
        <mkdir dir="${market-dist}"/>
        <!-- create a temp folder in which construct the archive the compress it-->
             
        <delete dir="${market-dist}"/>
        <mkdir dir="${market-dist}/${package.name}"/>
        <copy todir="${market-dist}/${package.name}" includeEmptyDirs="false">
            <fileset dir="${plugin-dist}">
            </fileset>
        </copy>
        <zip destfile="${market-dist}/${package.name}-${framework.required.major}.${framework.required.minor}.${framework.required.build}-${package.version}.${package.type}" basedir="${market-dist}" />

        <!-- create a README file with usefull informations for developer -->
        <echo file="${market-dist}/README.TXT" append="false">
            This package is part of Freedomotic building automation framework.
            This package is released under the terms of ${package.license} license by ${package.vendor.name} ${package.vendor.surname}.

            PLEASE UPDATE this info in plugin manifest XML files if they are not correct, otherwise the plugins may be not loaded at framework startup!

            You can create a plugin page on our marketplace and upload the compressed file ${package.name}.zip as it is.

            For more detailed instructions see the related project wiki page
            http://code.google.com/p/freedomotic/wiki/PostOnMarket

            For any problem you can contact freedomotic staff on the project developers mailing list
            https://groups.google.com/forum/?hl=en#!forum/freedom-domotics
        </echo>
        <delete dir="${market-dist}/${package.name}"/>        
        <echo>Done... Read README files in ${market-dist} and ${plugin-dist} folder to get help.</echo>
    </target>
</project>
